---
phase: 06-results-email-button
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/src/routes/email.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - 'Backend accepts POST /api/send-results/:sessionId (no 404 route mismatch)'
    - 'Frontend continues calling POST /api/send-results/:sessionId via services/apiClient.ts'
    - 'Backend build succeeds after the route fix'
  artifacts:
    - path: 'api/src/routes/email.ts'
      provides: 'Fastify POST handler mounted under /api/send-results prefix'
      pattern: "app.post<{ Params: { sessionId: string } }>('\\/\\:sessionId'"
    - path: 'api/src/server.ts'
      provides: 'Registers emailRoutes under /api/send-results prefix'
      pattern: "register\\(emailRoutes, \\{ prefix: '\\/api\\/send-results' \\}\\)"
    - path: 'services/apiClient.ts'
      provides: 'Frontend helper calls /api/send-results/:sessionId'
      pattern: "fetch\\(`\\$\\{API_BASE\\}\\/send-results\\/\\$\\{sessionId\\}\\}`"
  key_links:
    - from: 'api/src/server.ts'
      to: 'api/src/routes/email.ts'
      via: "app.register(emailRoutes, { prefix: '/api/send-results' })"
      pattern: "register\\(emailRoutes, \\{ prefix: '\\/api\\/send-results' \\}\\)"
    - from: 'services/apiClient.ts'
      to: '/api/send-results/:sessionId'
      via: 'fetch to API_BASE + /send-results/:sessionId'
      pattern: "\\/send-results\\/\\$\\{sessionId\\}"
---

<objective>
Fix the backend route mismatch causing 404 when the frontend calls POST /api/send-results/:sessionId.

Purpose: Unblock the "Receber por E-mail" button by ensuring the backend route path matches the frontend expectation.
Output: A single corrected Fastify route path (no duplicated /send-results segment).
</objective>

<execution_context>
@/home/mvrdu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/mvrdu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/06-results-email-button/06-results-email-button-UAT.md

@api/src/server.ts
@api/src/routes/email.ts
@services/apiClient.ts
</context>

<tasks>

<task type="auto">
  <name>Remove duplicated /send-results segment from email route</name>
  <files>
    api/src/routes/email.ts
  </files>
  <action>
    Make the minimal, safe change to eliminate the duplicated path segment causing the effective route to become /api/send-results/send-results/:sessionId.

    Keep the external API path expected by the frontend: POST /api/send-results/:sessionId.

    Implementation:
    - In api/src/routes/email.ts, change the route path from '/send-results/:sessionId' to '/:sessionId'.
      Rationale: server.ts already mounts emailRoutes with prefix '/api/send-results', so the route should only append the ':sessionId' segment.

    Do NOT change services/apiClient.ts (frontend expectation is locked by UAT constraints).
    Do NOT introduce new endpoints or refactors; keep changes minimal.

  </action>
  <verify>
    - Backend compiles: `cd api && npm run build`
    - Manual route smoke check (should NOT be 404):
      1) In one terminal: `cd api && npm run dev`
      2) In another terminal:
         `curl -s -o /dev/null -w "%{http_code}\n" -X POST "http://localhost:4000/api/send-results/test-session-id"`
         Expected: not `404` (200 if email is configured; 500 is acceptable for this smoke check as long as route is found)
  </verify>
  <done>
    POST /api/send-results/:sessionId no longer returns Fastify "Route ... not found" (404) due to route mismatch.
  </done>
</task>

</tasks>

<verification>
- UAT gap #2 root cause is resolved: backend route mismatch removed; frontend path remains POST /api/send-results/:sessionId
</verification>

<success_criteria>

1. Clicking "Receber por E-mail" no longer fails with a 404 Route Not Found for POST /api/send-results/:sessionId.
   </success_criteria>

<output>
After completion, create `.planning/phases/06-results-email-button/06-02-SUMMARY.md`
</output>
