---
phase: 06-results-email-button
plan: 01
type: execute
wave: 1
depends_on: [05-email-results]
files_modified:
  - components/test/ResultsScreen.tsx
  - services/apiClient.ts
  - components/test/AptitudeTest.tsx
autonomous: true

must_haves:
  truths:
    - 'On Results screen, user sees a "Receber por E-mail" action next to the existing download actions'
    - 'Clicking "Receber por E-mail" calls POST /api/send-results/:sessionId via services/apiClient.ts'
    - 'ResultsScreen only shows the email action when sessionId is available'
    - 'Frontend build succeeds after changes'
  artifacts:
    - path: 'components/test/ResultsScreen.tsx'
      provides: 'Email send button UI + state (idle/sending/success/error)'
      contains: 'Receber por E-mail'
    - path: 'services/apiClient.ts'
      provides: 'sendEmailResult(sessionId) API call helper'
      exports: ['sendEmailResult']
    - path: 'components/test/AptitudeTest.tsx'
      provides: 'Passes currentSessionId into ResultsScreen as sessionId prop'
      pattern: '<ResultsScreen.*sessionId={currentSessionId}'
  key_links:
    - from: 'components/test/ResultsScreen.tsx'
      to: 'services/apiClient.ts'
      via: 'import + await sendEmailResult(sessionId)'
      pattern: 'sendEmailResult\(sessionId\)'
    - from: 'services/apiClient.ts'
      to: '/api/send-results/:sessionId'
      via: 'fetch to API_BASE + /send-results'
      pattern: 'fetch\(`\$\{API_BASE\}/send-results/\$\{sessionId\}`'
---

<objective>
Add a "Receber por E-mail" button on the test results page, matching the existing dark-theme UI and positioned alongside the existing download actions (PDF/JSON). Wire it to the existing backend email endpoint via the frontend API client.

Purpose: Users can request receiving their results by email from the results screen without leaving the flow.
Output: ResultsScreen action button + apiClient helper usage + sessionId wiring.
</objective>

<execution_context>
@/home/mvrdu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/mvrdu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-email-results/05-01-SUMMARY.md
@.planning/phases/05-email-results/05-02-SUMMARY.md

@components/test/ResultsScreen.tsx
@services/apiClient.ts
@components/test/AptitudeTest.tsx
@api/src/server.ts
@api/src/routes/email.ts
</context>

<tasks>

<task type="auto">
  <name>Add "Receber por E-mail" action in ResultsScreen</name>
  <files>
    components/test/ResultsScreen.tsx
  </files>
  <action>
    Implement a third action button in the ResultsScreen "Actions" area:
    - Label: "Receber por E-mail" (pt-BR)
    - Position: alongside existing download actions (PDF/JSON) while preserving current layout styles.
    - Only render the button when sessionId is present (prop is optional).
    - Add local UI state: idle | sending | success | error.
      - sending: disable button, show "Enviando..."
      - success: show "Enviado!" then reset to idle after ~3s
      - error: show "Erro. Tentar?" then reset to idle after ~3s
    - On click, call the existing API helper `sendEmailResult(sessionId)` and handle errors with console.error.

    IMPORTANT: Do not remove existing PDF/JSON downloads. Keep dark-theme Tailwind styling consistent with existing buttons.

  </action>
  <verify>
    - `npm run build` (root) succeeds
  </verify>
  <done>
    Results screen shows a "Receber por E-mail" button (when sessionId exists) with sending/success/error UI states.
  </done>
</task>

<task type="auto">
  <name>Ensure sessionId wiring and API helper are in place</name>
  <files>
    components/test/AptitudeTest.tsx
    services/apiClient.ts
  </files>
  <action>
    Confirm end-to-end wiring for the button:
    - AptitudeTest passes `currentSessionId` into ResultsScreen as `sessionId` prop.
    - services/apiClient.ts exports `sendEmailResult(sessionId: string): Promise<void>` that POSTs to `${API_BASE}/send-results/${sessionId}`.
      - API_BASE must respect `import.meta.env.VITE_API_URL || '/api'`.

    If any of these are missing, implement them following existing patterns (do not introduce new client libraries).

  </action>
  <verify>
    - `npm run build` succeeds
  </verify>
  <done>
    ResultsScreen can call sendEmailResult with a real sessionId from AptitudeTest.
  </done>
</task>

</tasks>

<verification>
- Frontend compiles: `npm run build`
- ResultsScreen contains the pt-BR label "Receber por E-mail" and calls sendEmailResult(sessionId)
- sessionId is passed from AptitudeTest to ResultsScreen
</verification>

<success_criteria>

1. Users see a "Receber por E-mail" button on the results screen (when session exists) with consistent styling.
2. Clicking it triggers a POST to `/api/send-results/:sessionId` via services/apiClient.ts.
3. Build passes.
   </success_criteria>

<output>
After completion, create `.planning/phases/06-results-email-button/06-01-SUMMARY.md`
</output>
