---
phase: 05-email-results
plan: 02
type: execute
wave: 2                     # Depends on 05-01 (Wave 1)
depends_on: [05-email-results/05-01]  # Requires backend email infrastructure
files_modified:
  - api/src/server.ts        # Register email route with Prisma
  - api/package.json        # Add @fastify/prisma plugin
  - services/apiClient.ts   # Add email API call to client
  - components/test/ResultsScreen.tsx  # Trigger email after test completion
autonomous: false           # Human verification checkpoint
user_setup: []              # No new human setup (SMTP configured in 05-01)

must_haves:
  truths:
    - "User completes the test successfully"
    - "Email endpoint is called with valid sessionId after test completion"
    - "Email is sent to the authenticated user's email address"
    - "Email contains the user's identified tech profile summary"
    - "Email contains a clickable link to the full results page"
  artifacts:
    - path: "api/src/server.ts"
      provides: "Registered email route integrated with Prisma plugin"
      content: "Uncomment import, register route, ensure prismaPlugin loaded"
    - path: "api/package.json"
      provides: "@fastify/prisma plugin for database access"
      contains: "fastify-plugin/prisma"
    - path: "services/apiClient.ts"
      provides: "API client function to call send results endpoint"
      exports: ["sendEmailResult"]
    - path: "components/test/ResultsScreen.tsx"
      provides: "Frontend component triggering email after API success"
      pattern: "sendEmailResult.*in onSubmitSuccess"
    - path: ".env.docker"
      provides: "SMTP configuration (from 05-01 SUMMARY)"
      pattern: "SMTP_HOST|SMTP_PORT|SMTP_USER|SMTP_PASS|SMTP_FROM"
  key_links:
    - from: "components/test/ResultsScreen.tsx"
      to: "api/src/routes/email.ts"
      via: "sendEmailResult() API call from apiClient"
      pattern: "apiClient.sendEmailResult.*sessionId"
    - from: "api/src/server.ts"
      to: "api/src/routes/email.ts"
      via: "await app.register(emailRoutes, { prefix: '/api/send-results' })"
      pattern: "import.*emailRoutes.*server.ts.*register"
    - from: "api/src/routes/email.ts"
      to: "api/src/services/email.ts"
      via: "sendResults() execution called by route handler"
      pattern: "emailService.sendResults\(.*\)"
---

<objective>
Uncomment and register email route in server.ts, add email client function to frontend API client, and integrate email triggering into ResultsScreen component so users automatically receive their test results via email after completing the test.

Purpose: Connect the backend email infrastructure to the frontend test completion flow, ensuring users get immediate feedback without navigation to the results page. This is the critical bridge between plan 1 (infrastructure) and user-facing value.

Output: Registered email API endpoint, frontend email trigger function, functional email notification on test completion
</objective>

<execution_context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-email-results/05-01-SUMMARY.md

# Reference for existing work:

- Email service in api/src/services/email.ts (sendResults() function)
- Email route in api/src/routes/email.ts (POST /api/send-results/:sessionId)
- Route registration placeholder in api/src/server.ts (line 10)
- SMTP config in .env.docker (from 05-01)
  </execution_context>

<context>
# Context from Plan 05-01 Summary
Ema infrastructure complete with:
- Nodemailer email service with SMTP transport (api/src/services/email.ts)
- TypeBox validation schema for email requests (api/src/schemas/email.ts)
- Fastify route handler for POST /api/send-results/:sessionId (api/src/routes/email.ts)
- Placeholder for route registration in server.ts with TODO comment
- .env.docker with SMTP configuration variables

# User Authentication Flow

- User authenticates with email on WelcomeScreen
- JWT token issued on valid email from authorized_emails table
- Test session created via /api/sessions/start
- Answers collected during test
- Results saved to database after completion
- Expected: Email sent immediately after submission

# Current State

- 05-01 completed email infrastructure but route is NOT registered
- server.ts line 10 has commented-out import: `// import { emailRoutes } from './routes/email.js'`
- Frontend has no email trigger mechanism
- No API client function for email endpoint
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Register email route with full Prisma integration</name>
  <files>
    api/src/server.ts
    api/package.json
  </files>
  <action>
    **Step 1 - Update api/package.json:**
    - Add `fastify-plugin/prisma` to dependencies (verify already installed via prismaPlugin import)

    **Step 2 - Update api/src/server.ts:**
    - Uncomment line 10: Remove `//` from `import { emailRoutes } from './routes/email.js'`
    - Register email route after resultRoutes (around line 31):
      ```typescript
      await app.register(emailRoutes, { prefix: '/api/send-results' });
      ```
    - Ensure prismaPlugin is already registered (line 25) — route needs it for database queries

    **Why:**
    - Un-commented import connects route to backend
    - Route needs Prisma plugin to query `test_sessions` table by sessionId
    - Route registers at /api/send-results/:sessionId to match frontend expectation

    **Avoid:**
    - Don't change route prefix (must match frontend call)
    - Don't move emailRoutes before resultRoutes or other route imports

  </action>
  <verify>
    - In api directory: `npm run build` completes without errors
    - Check server.ts imports: emailRoutes is now un-commented
    - Check server.ts routes: emailRoutes is registered after resultRoutes
  </verify>
  <done>Backend route is registered and accessible at POST /api/send-results/:sessionId with Prisma database access</done>
</task>

<task type="auto">
  <name>Task 2: Add email trigger function to frontend API client</name>
  <files>
    services/apiClient.ts
    services/types.ts
  </files>
  <action>
    **Step 1 - Read services/apiClient.ts to understand current structure:**
    - Identify API client utility functions (getCurrentUser, createSession, saveAnswer, etc.)
    - Note error handling pattern (ApiError extends Error with status property)
    - Check base URL configuration (http://localhost:4000 for dev)

    **Step 2 - Add new email trigger function:**
    - Create `sendEmailResult(sessionId: string)` function using existing API client pattern
    - Implementation:
      ```typescript
      const sendEmailResult = async (sessionId: string): Promise<void> => {
        try {
          await fetch('http://localhost:4000/api/send-results/' + sessionId, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              // No auth header needed - route validates JWT on request or doesn't require it yet
            },
          });

          if (!response.ok) {
            // Email failed - log but don't throw (non-blocking)
            console.error('Email failed to send for session:', sessionId);
          }

          // Fire-and-forget - don't await
        } catch (err) {
          // Also log error but don't block flow
          console.error('Email API call error:', err);
        }
      };
      ```

    **Why:**
    - Central API client maintains testable pattern
    - Fire-and-forget allows test completion to proceed even if email fails
    - Non-blocking error logging for debugging

    **Avoid:**
    - Don't add auth headers (route doesn't currently require JWT)
    - Don't return status — email is informational only

  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - Function is exported from services/apiClient.ts
    - Function uses existing fetch pattern (not axios, uses native fetch per conventions)
    - Try/catch with console.error error handling (matches existing pattern)
  </verify>
  <done>API client includes sendEmailResult() function ready to call email endpoint with sessionId</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Test complete email notification flow end-to-end</name>
  <what-built>
    Complete integration of email route registration, API client function, and frontend trigger. Email should be sent when user completes test.
  </what-built>
  <how-to-verify>
    **Prerequisites:**
    - SMTP credentials configured in .env.docker (from 05-01)
    - PostgreSQL container running (test_sessions table exists)

    **Test Steps:**
    1. Start all services:
       ```bash
       docker compose --env-file .env.docker up -d
       npm run dev      # Frontend on :3000
       cd api && npm run dev  # Backend on :4000
       ```

    2. Test email notification:
       - Open http://localhost:3000 and enter an authorized email (from authorized_emails table)
       - Complete the aptitude test with answers
       - After submission (ResultsScreen shows up), check for email in inbox

    **Expected Outcomes:**
    - Email appears in user's inbox at authenticated email address
    - Email subject: "Resultado do Teste de Competências Técnicas"
    - Email body contains:
      - Profile summary (e.g., "Desenvolvedor Fullstack")
      - Dark-themed HTML with professional design
      - Link: https://localhost:3000/teste/{sessionId}/results
    - Backend logs show email sent success message (if NODE_ENV=production)
    - Frontend shows ResultsScreen (test completion continues regardless of email status)

    **If email fails:**
    - Check Docker postgres logs: `docker compose -f api/docker-compose.yml logs db`
    - Check backend logs for Prisma errors (if route tries to query test_sessions)
    - Check email logs for SMTP connection errors in .env.docker SMTP_* variables

  </how-to-verify>
  <resume-signal>Type "approved" if email arrives with correct content, or describe any issues (SMTP errors, missing email, wrong content, link broken)</resume-signal>
</task>

</tasks>

<verification>
[Overall phase checks]
Email results feature complete when:
- Backend route is registered and accessible
- API client can call email endpoint
- Frontend triggers email on test completion
- Email is delivered to user's inbox with correct content
- Test completion flow is non-blocking (doesn't wait for email)
</verification>

<success_criteria>
**Measurable completion:**

1. **Backend route accessible** — `curl -X POST http://localhost:4000/api/send-results/test-session-id` returns 200 or 500 (acceptable) but not 404

2. **Email delivered** — User receives email within 5 seconds of test completion at authenticated email address

3. **Email content correct** — Email contains both profile summary and clickable link to results page

4. **Frontend integration works** — ResultsScreen appears after submission, backend logs don't show email API errors (only informational)

5. **Non-blocking flow** — Test completion succeeds even if email delivery fails (user sees ResultsScreen, no console errors blocking submission)
   </success_criteria>

<output>
After completion, create `.planning/phases/05-email-results/05-02-SUMMARY.md` with:
- Duration and completion time
- Task commits
- Files created/modified list
- Any deviations or issues encountered
- User setup requirements (if any new ones beyond 05-01)
- End-to-end test results
</output>

<notes>
**Critical implementation notes:**
- SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM must be configured in .env.docker (from 05-01)
- The route at api/src/routes/email.ts may have TODO comments about database queries — ensure it's integrated with Prisma plugin
- Email trigger is fire-and-forget to avoid blocking test completion
- Frontend uses http://localhost:4000 (dev proxy from Vite to backend)
</notes>
