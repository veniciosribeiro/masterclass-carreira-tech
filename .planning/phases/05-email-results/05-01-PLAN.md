---
phase: 05-email-results
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  [
    'api/package.json',
    'api/src/services/email.ts',
    'api/.env.docker',
    'api/src/index.ts',
  ]
autonomous: true
must_haves:
  truths:
    - 'Nodemailer installed in api package'
    - 'Email service module exports sendEmail and sendResults functions'
    - 'SMTP configuration environment variables defined in .env.docker'
    - 'Email route registered at POST /api/send-results/:sessionId'
  artifacts:
    - path: 'api/src/services/email.ts'
      provides: 'Email service with Nodemailer transporter and sendResults function'
      min_lines: 100
    - path: 'api/src/routes/email.ts'
      provides: 'POST /api/send-results/:sessionId endpoint'
      exports: ['routes']
    - path: 'api/src/schemas/email.ts'
      provides: 'TypeBox validation schema for email requests'
      exports: ['SendResultsBody', 'SendResultsBodyType']
  key_links:
    - from: 'api/src/services/email.ts'
      to: 'api/.env.docker'
      via: 'SMTP_HOST, SMTP_USER, SMTP_PASS, SMTP_FROM'
      pattern: "process\\.env\\"
    - from: 'api/src/routes/email.ts'
      to: 'api/src/services/email.ts'
      via: "import { sendResults } from './services/email.js'"
      pattern: 'import.*sendResults'
---

<objective>
Create backend email infrastructure for sending test results via SMTP using Nodemailer. Implementation includes email service module, validation schema, and trigger route that integrates with test completion flow.
</objective>

<execution_context>
@/home/mvrdu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/mvrdu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-email-results/05-RESEARCH.md

# Existing Backend Context

**Route patterns**: Fastify routes follow pattern `export async function routes(app: FastifyInstance)`
**Schema patterns**: TypeBox schemas use `Type.Object()` for request bodies
**Error handling**: Return `reply.code(404).send({ error: 'not_found' })` for missing resources
**Module structure**: `src/services/` directory exists for business logic services

# Research Findings

**Email Service Choice**: Nodemailer (mature, TypeScript support)
**Architecture**: Service module → Transporter → SMTP → Email recipient
**Key Decision**: HTML email template (no PDF attachment required for immediate delivery)
</context>

<tasks>

<task type="auto">
  <name>Install Nodemailer and create email module structure</name>
  <files>
    api/package.json
    api/src/services/email.ts
    api/.env.docker
  </files>
  <action>
    1. Install Nodemailer in api/ directory:
       ```bash
       cd api && npm install nodemailer --save-exact && cd ..
       ```

    2. Create email service module at `api/src/services/email.ts`:
       - Import required libraries: `nodemailer`
       - Define EmailData interface with fields: `to` (string), `subject` (string), `htmlBody` (string)
       - Create transporter using SMTP from environment variables:
         - `process.env.SMTP_HOST`
         - `process.env.SMTP_PORT` (default 587)
         - `process.env.SMTP_SECURE` (parse to boolean, default false)
         - `process.env.SMTP_USER`
         - `process.env.SMTP_PASS`
       - Provide fallback if env vars missing (throw descriptive error)

    3. Add SMTP environment variables to `api/.env.docker`:
       - SMTP_HOST: Your SMTP provider (e.g., SendGrid, Mailtrap, Gmail)
       - SMTP_PORT: 587 for TLS, 465 for SSL
       - SMTP_SECURE: false for TLS (port 587), true for SSL (port 465)
       - SMTP_USER: Your SMTP username (e.g., from SendGrid)
       - SMTP_PASS: Your SMTP password/pair of keys
       - SMTP_FROM: Email address from which emails are sent (e.g., noreply@techcareer.com)

    4. Add email service export to `api/src/index.ts` (if it exists):
       - Add: `export { sendEmail } from './services/email.js'`

    Reference email service patterns from existing backend services in `api/`.

    **File path format**: Use `.js` extension since api/backend uses NodeNext moduleResolution
    **Error handling**: Throw `Error` with descriptive message if env vars missing or transport fails

  </action>
  <verify>
    - npm list nodemailer shows installed
    - api/src/services/email.ts exports sendEmail function
    - api/.env.docker has SMTP_HOST and SMTP_FROM defined
    - No TypeScript type errors: ```bash
      cd api && npm run build
      ```
  </verify>
  <done>
    Nodemailer installed, email service module created, SMTP config added to .env.docker
  </done>
</task>

<task type="auto">
  <name>Create email template and results-trigger route</name>
  <files>
    api/src/services/email.ts (updated)
    api/src/routes/email.ts (new)
    api/src/schemas/email.ts (new)
    api/src/server.ts (updated)
  </files>
  <action>
    1. Update `api/src/services/email.ts` to add email template:
       - Add HTML email template as string constant
       - Template should include:
         - Subject line with "Seus Resultados do TechCareer Test" in Portuguese
         - Personalized greeting
         - Tech profile summary (e.g., "Você é um Fullstack Developer")
         - Brief score breakdown summary
         - Clickable link to results report (e.g., `http://localhost:3000/teste/${sessionId}`)
         - Company branding/information
         - Call-to-action button
       - Template uses placeholders for sessionId, name, profile, scores
       - Use Tailwind CSS classes for styling (dark theme compatible):
         ```html
         <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto; color: #C9D1D9; background: #161B22;">
           <div style="padding: 20px;">
             <h1 style="color: #19e65e;">Seus Resultados do TechCareer Test</h1>
             <p>Olá, [name]!</p>
             ...
           </div>
         </div>
         ```

    2. Add sendResults function to email service:
       - Accept parameters: `to` (string), `name` (string), `sessionId` (string), `profile` (string), `scores` (object)
       - Generate HTML body from template with placeholders
       - Call existing sendEmail with personalized content

    3. Create email schema at `api/src/schemas/email.ts`:
       - Export `SendResultsBody` using TypeBox:
         ```ts
         import { Type } from '@fastify/typebox'

         export const SendResultsBody = Type.Object({
           sessionId: Type.String(),
           email: Type.Optional(Type.String())
         })
         export type SendResultsBodyType = Static<typeof SendResultsBody>
         ```

    4. Create email route at `api/src/routes/email.ts`:
       - Import: FastifyInstance, SendResultsBody
       - Export `routes` function:
         ```ts
         export async function routes(app: FastifyInstance) {
           app.post<{ Body: SendResultsBodyType; Params: { sessionId: string } }>('/send-results/:sessionId', {
             schema: { body: SendResultsBody }
           }, async (request, reply) => {
             const { sessionId } = request.params

             // TODO: Fetch test results, profile, scores from database
             // TODO: Call email service to send results
             // TODO: Return success response with delivery info

             return reply.code(200).send({
               message: 'Email sent successfully',
               sessionId
             })
           })
         }
         ```

    5. Register email route in `api/src/server.ts`:
       - Import: `routes` from `./routes/email.js`
       - Register: `await app.register(routes, { prefix: '/api' })`
       - Add file extension `.js` (NodeNext moduleResolution)

    **Note**: For integration, route should fetch test results, profile, scores from database before sending. Start with placeholder logic and add real data fetching in next phase or integration.

    **Template placeholders**:
    - `{{name}}` — User's name from JWT payload
    - `{{profile}}` — Tech profile identifier (e.g., "Fullstack Developer")
    - `{{scores}}` — Object with section scores
    - `{{link}}` — Results page URL with sessionId

  </action>
  <verify>
    - TypeScript compilation succeeds: ```bash
      cd api && npm run build
      ```
    - Route registered in server (check for no type errors)
    - Email service module exports both sendEmail and sendResults
    - No linting errors: ```bash
      npx eslint \
        api/src/services/email.ts \
        api/src/routes/email.ts \
        api/src/schemas/email.ts
      ```
  </verify>
  <done>
    HTML email template created, results trigger route ready, integration with Fastify complete
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- [ ] Email service module implemented with Nodemailer
- [ ] SMTP configuration added to .env.docker
- [ ] HTML email template with Portuguese content exists
- [ ] `sendResults` function accepts test results parameters
- [ ] Email route registered with Fastify
- [ ] No TypeScript or ESLint errors in backend
</verification>

<success_criteria>

1. Backend email system (module + route) compiles without errors
2. sendEmail and sendResults functions defined and typed
3. SMTP credentials structure present in .env.docker
4. Email route registered and accessible at POST /api/send-results/:sessionId
5. Template system ready for test data injection
   </success_criteria>

<output>
After completion, create `.planning/phases/05-email-results/05-01-SUMMARY.md`
</output>
