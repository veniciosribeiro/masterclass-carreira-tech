---
phase: 03-git-hooks
plan: 01
type: execute
wave: 1
depends_on: [02-prettier-integration]
files_modified:
  - package.json
  - .husky/pre-commit
autonomous: true

must_haves:
  truths:
    - 'Husky is installed and hooks are active'
    - 'Pre-commit hook runs lint-staged'
    - 'lint-staged runs ESLint and Prettier on staged files only'
    - 'Committing a file with lint errors fails'
    - 'Committing a file with formatting issues fixes them automatically'
  artifacts:
    - path: '.husky/pre-commit'
      provides: 'Git hook script'
      contains: 'lint-staged'
    - path: 'package.json'
      provides: 'Husky and lint-staged dependencies'
      exports: ['prepare', 'lint-staged']
  key_links:
    - from: '.husky/pre-commit'
      to: 'package.json'
      via: 'lint-staged command'
---

<objective>
Implement automated code quality enforcement using Git hooks. Install Husky to trigger scripts on commit, and configure lint-staged to run ESLint and Prettier only on modified files, ensuring no bad code enters the repository.

**Purpose:** Prevent regression and maintain code style consistency automatically, removing the need for manual linting before commits.

**Output:** A configured Git hook system that blocks commits with errors and auto-formats code.
</objective>

<execution_context>
@/home/mvrdu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/mvrdu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
@eslint.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Husky and lint-staged</name>
  <files>
    package.json
    package-lock.json
  </files>
  <action>
Install Husky (v9+) and lint-staged (v15+) as dev dependencies in the root package.

```bash
npm install --save-dev husky@^9.0.0 lint-staged@^15.0.0
```

Initialize Husky to create the `.husky` directory and add the `prepare` script to `package.json`:

```bash
npx husky init
```

**Rationale:**

- Husky v9 is the latest major version with simplified config (no more `.huskyrc`).
- `lint-staged` allows running tasks on specific files based on glob patterns.
  </action>
  <verify>
  Check that `.husky` directory exists and `prepare` script is in `package.json`.

```bash
ls -d .husky
grep '"prepare": "husky"' package.json
```

  </verify>
  <done>
- Husky and lint-staged installed
- .husky directory created
- prepare script added to package.json
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure lint-staged</name>
  <files>
    package.json
  </files>
  <action>
Configure `lint-staged` in `package.json` to run ESLint and Prettier on supported files.

Add to `package.json`:

```json
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.{json,md,yml,yaml,css,html}": [
      "prettier --write"
    ]
  }
```

**Rationale:**

- `eslint --fix` attempts to fix lint errors automatically.
- `prettier --write` formats files.
- Configuration covers both code files (JS/TS) and asset/config files (JSON/MD/YML).
- Running from root covers both frontend and `api/` backend files because ESLint config supports monorepo.
  </action>
  <verify>
  Inspect `package.json` to ensure `lint-staged` key exists with correct patterns.

```bash
grep -A 10 '"lint-staged"' package.json
```

  </verify>
  <done>
- lint-staged configured in package.json
- JS/TS files run eslint fix and prettier write
- Other files run prettier write
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure pre-commit hook</name>
  <files>
    .husky/pre-commit
  </files>
  <action>
Update the pre-commit hook to run lint-staged.

Edit `.husky/pre-commit`:

```bash
echo "npx lint-staged" > .husky/pre-commit
```

And ensure it is executable (Husky v9 handles this, but good to be sure).

**Rationale:**

- The hook triggers `lint-staged` which then filters files and runs commands.
- If `lint-staged` fails (e.g., unfixable ESLint error), the commit aborts.
  </action>
  <verify>
  Check content of pre-commit hook.

```bash
cat .husky/pre-commit
```

Expected output: `npx lint-staged` (possibly with shebang if Husky added it, but Husky 9 is minimal).
</verify>
<done>

- .husky/pre-commit set to run npx lint-staged
  </done>
  </task>

</tasks>

<verification>
After tasks complete:

```bash
# 1. Verify dependencies
npm list husky lint-staged

# 2. Dry run lint-staged (simulated)
# Create a dummy file with errors, stage it, run lint-staged, see failure, then delete it.
echo "const x = 1" > temp-lint-test.js
git add temp-lint-test.js
npx lint-staged --verbose
# Expect: Prettier changes it (formatted), ESLint might complain about unused var (depending on rule)
# Clean up
git reset temp-lint-test.js
rm temp-lint-test.js
git checkout package.json # Revert any accidental changes if verification touched tracked files
```

</verification>

<success_criteria>

1. **Husky installed:** `.husky` directory exists.
2. **Hooks active:** `git commit` runs the hook (can be tested manually by user).
3. **lint-staged configured:** `package.json` has configuration.
4. **Integration:** Running `npx lint-staged` works without error on clean project.
   </success_criteria>

<output>
After completion, create `.planning/phases/03-git-hooks/03-01-SUMMARY.md`.
</output>
